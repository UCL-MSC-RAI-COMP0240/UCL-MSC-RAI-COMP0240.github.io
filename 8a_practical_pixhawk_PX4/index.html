<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Practical 8a: Pixhawk and PX4, Commercial and R&amp;D Autonomous Drone Systems - UCL-MSC-RAI-COMP0240</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../kbd.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Practical 8a: Pixhawk and PX4, Commercial and R\u0026amp;D Autonomous Drone Systems";
        var mkdocs_page_input_path = "8a_practical_pixhawk_PX4.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> UCL-MSC-RAI-COMP0240
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Practical 1 & 2</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../1a_introduction/">1. Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../1b_intro_linux/">2. Ubuntu Installation and Linux Re-Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../1c_intro_ros2/">3. ROS2 Installation and ROS2 Re-Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../1d_aerostack2/">4. Aerostack2 Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../2_practical_gazebo_aruco/">5. Gazebo Aruco Mini-Challenge</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Practical 3 & 4</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../2_practical_gazebo_aruco/">5. Gazebo Aruco Mini-Challenge</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../3a_practical_crazyflie/">7. Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../3b_practical_crazyflie/">8. Building Crazyflies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../4_practical_crazyflie/">9. Flying Crazyflies</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Practical 5</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../5_practical_crazyflie_aerostack2/">10. Crazyflie with Aerostack2</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Practical 6: Assignment - CW1</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../3_challenge_cw1/">Structural Inspection Path Planning Challenge</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Practical 7</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="../tbc.md">11. Flight Practice, Regulation and Laws (tbc at UCL HereEast)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Practical 8</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../8a_practical_px4_sitl/">12. Introducing Pixhawk and PX4</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../8b_practical_PX4_Aerostack2_ROS2/">13. Autonomous flight with PX4, ROS2 and aerostack2</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Practical 9 & 10: Assignment - CW2</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../7_challenge_multi_drone/">Multi-Drone Swarming Formation Flight Challenge</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">UCL-MSC-RAI-COMP0240</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Practical 8a: Pixhawk and PX4, Commercial and R&amp;D Autonomous Drone Systems</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="practical-8a-pixhawk-and-px4-commercial-and-rd-autonomous-drone-systems">Practical 8a: Pixhawk and PX4, Commercial and R&amp;D Autonomous Drone Systems<a class="headerlink" href="#practical-8a-pixhawk-and-px4-commercial-and-rd-autonomous-drone-systems" title="Permanent link">&para;</a></h1>
<div class="toc">
<ul>
<li><a href="#practical-8a-pixhawk-and-px4-commercial-and-rd-autonomous-drone-systems">Practical 8a: Pixhawk and PX4, Commercial and R&amp;D Autonomous Drone Systems</a><ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#what-is-pixhawk">What is Pixhawk?</a><ul>
<li><a href="#common-pixhawk-versions">Common Pixhawk Versions:</a></li>
<li><a href="#how-to-use-a-pixhawk">How to use a Pixhawk</a></li>
</ul>
</li>
<li><a href="#flight-control-firmware">Flight Control Firmware</a></li>
<li><a href="#px4-software-stack">PX4 Software Stack</a><ul>
<li><a href="#autopilot-communication">Autopilot communication</a></li>
<li><a href="#ground-stations">Ground Stations</a></li>
</ul>
</li>
<li><a href="#setting-up-pixhawk-with-px4-and-qgroundcontrol">Setting Up Pixhawk with PX4 and QGroundControl</a><ul>
<li><a href="#setup-overview">Setup Overview</a></li>
<li><a href="#install-qgroundcontrol">Install QGroundControl</a></li>
<li><a href="#power-up-and-connect-the-pixhawk">Power up and connect the Pixhawk</a></li>
<li><a href="#flashing-the-pixhawk">Flashing the Pixhawk</a></li>
<li><a href="#sensor-calibration">Sensor Calibration</a></li>
<li><a href="#continue-setup">Continue Setup</a></li>
<li><a href="#next-step">Next step</a></li>
</ul>
</li>
<li><a href="#using-px4-in-hitl-hardware-in-the-loop-simulation">Using PX4 in HITL (Hardware-In-The-Loop) Simulation</a><ul>
<li><a href="#installing-dependencies">Installing Dependencies</a><ul>
<li><a href="#ubuntu">Ubuntu</a></li>
<li><a href="#jmavsim-install-ubuntu-tested">JMavSim Install (Ubuntu Tested)</a></li>
</ul>
</li>
<li><a href="#steps-to-run-px4-hitl">Steps to Run PX4 HITL:</a><ul>
<li><a href="#starting-pixhawk">Starting Pixhawk</a></li>
<li><a href="#configuring-your-pixhawkpx4-installation-for-hitl">Configuring your Pixhawk/PX4 installation for HITL</a></li>
<li><a href="#running-jmavsim">Running JMAVSim</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tasks">Tasks</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>Pixhawk and PX4 are widely used in autonomous drone development, providing an open-source hardware and software ecosystem for UAV control. In this tutorial, we will introduce:</p>
<ul>
<li><strong>Pixhawk</strong>: The hardware autopilot platform</li>
<li><strong>PX4</strong>: The open-source flight control firmware</li>
<li><strong>How to set up and use PX4 with Pixhawk</strong></li>
<li><strong>PX4 Hardware In The Loop (HITL) Testing</strong></li>
<li><strong>Creating Missions with QGC</strong></li>
</ul>
<p>This will help you transition from Crazyflies and Aerostack2 to more advanced UAV platforms.</p>
<h2 id="what-is-pixhawk">What is Pixhawk?<a class="headerlink" href="#what-is-pixhawk" title="Permanent link">&para;</a></h2>
<p>Pixhawk is a family of open-source flight controllers developed for UAVs and robotics applications. It provides:</p>
<ul>
<li>High-performance <strong>autopilot capabilities</strong></li>
<li><strong>Multiple sensor support</strong> (GPS, IMUs, barometers, etc.)</li>
<li><strong>Compatibility</strong> with PX4 and ArduPilot firmware</li>
<li>Connectivity options like <strong>UART, I2C, CAN, MAVLink and DDS</strong></li>
</ul>
<h3 id="common-pixhawk-versions">Common Pixhawk Versions:<a class="headerlink" href="#common-pixhawk-versions" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Pixhawk 4</strong>: Standard for academic and research use</li>
<li><strong>Pixhawk 6X</strong>: More advanced processing capabilities</li>
<li><strong>Pixhawk 6C</strong>: Compact version with strong processing power</li>
<li><strong>Pixhawk Mini</strong>: Compact version for small UAVs</li>
</ul>
<h3 id="how-to-use-a-pixhawk">How to use a Pixhawk<a class="headerlink" href="#how-to-use-a-pixhawk" title="Permanent link">&para;</a></h3>
<p>This is the Pixhawk 6C you will be playing around with, see all of the ports for various inputs</p>
<p><img alt="pixhawk6c" src="../images/Pixhawk6C.png" /></p>
<p>This following wiring diagram is from an older Pixhawk model, but should show the key elements of connecting up and powering a Pixhawk </p>
<p><img alt="wiring" src="../images/Pixhawk6CSampleWiringDiagram_2048x2048.webp" /></p>
<h2 id="flight-control-firmware">Flight Control Firmware<a class="headerlink" href="#flight-control-firmware" title="Permanent link">&para;</a></h2>
<p>There is no universal controller design of converting from user inputs to motor thrust. In the same way, there are numerous other functionalities that an autopilot can cover. These can range from running control loops for gimbals, cameras and other actuation, to high level mission following and safety features. These functionalities are bundled into specific autopilot <em>firmware</em> which each offer a slightly different set of features, as well as differing user interfaces each with their advantages and drawbacks.</p>
<p>The two current most common autopilot firmware's in use in research settings are <a href="https://ardupilot.org/copter/index.html">Ardupilot</a> which offers the Arducopter firmware, and <a href="https://px4.io/">PX4</a> which offers Multicopter firmware. Both these firmwares are very extensive and cover numerous use cases. However, for our purposes we will only cover enabling autonomous flight through observing the <em>mode</em> of the autopilot.</p>
<p>Both Ardupilot and PX4 use the concept of flight modes, where each mode operates and supports different levels or types of flight stabilisation and/or autonomous functions. Traditionally this is for pilots to change between different controller layouts for different applications. It's necessary to change to the correct mode for safe and controllable flight. The following table shows the most often used flight modes within Starling.</p>
<table>
<thead>
<tr>
<th><a href="https://ardupilot.org/copter/docs/flight-modes.html">Ardupilot Mode</a></th>
<th><a href="https://docs.px4.io/v1.12/en/getting_started/flight_modes.html">PX4 Mode</a></th>
<th>Functionality</th>
</tr>
</thead>
<tbody>
<tr>
<td>stabilized</td>
<td>manual</td>
<td>Full manual control with RC sticks being sent directly to control roll, pitch, yaw and height</td>
</tr>
<tr>
<td>PosHold</td>
<td>position</td>
<td>UAV uses onboard sensing to stay in place, RC sticks used to translate position</td>
</tr>
<tr>
<td>loiter</td>
<td>auto.hold</td>
<td>Automatic mode where UAV stays in the same location until further instructions given.</td>
</tr>
<tr>
<td>land</td>
<td>auto.land</td>
<td>Automatic mode which attempts to land the UAV</td>
</tr>
<tr>
<td>Guided</td>
<td>offboard</td>
<td>Navigates to setpoints sent to it by ground control or companion computer</td>
</tr>
</tbody>
</table>
<p>As mentioned before, the base purpose of the firmware is to provide a given cascading PID controller for converting high level commands to motor thrusts. However both firmwares provide a plethora of other functionality from trajectory following, basic mission following, telemetry and communications and many others too. </p>
<p>As a controller developer, it is also useful to understand the differences between the Ardupilot and PX4 controllers and what real-world impacts they have. In most of drone targeted applications we only require either position or velocity control which works fairly consistently between the two firmwares. </p>
<p>In our own work, it has generally been noted that Ardupilot seems to be more suitable for outdoor flight, and PX4 for indoor flight. For this tutorial we will be developing a controller for indoor multi-vehicle flight and so we will assume the use of PX4. The biggest difference is actually in licensing where Ardupilot's license specifies that any developments must be contributed back, however PX4 is a bit more free allowing the forking and commercialisation without needing the announce or contribute (although this is not necessarily the best for the longevity of this open source project!). </p>
<h2 id="px4-software-stack">PX4 Software Stack<a class="headerlink" href="#px4-software-stack" title="Permanent link">&para;</a></h2>
<p>PX4 consists of:</p>
<ol>
<li><strong>PX4 Firmware</strong> - The core flight control software</li>
<li><strong>QGroundControl (QGC)</strong> - GUI for setup and mission planning</li>
<li><strong>MAVSDK (or other communication method)</strong> - API for developing drone applications</li>
<li><strong>Hardware-In-The-Loop (HITL)</strong> - Using real Pixhawk hardware for simulation or <strong>Software-In-The-Loop (SITL)</strong> for using simulated drones for testing. </li>
</ol>
<h3 id="autopilot-communication">Autopilot communication<a class="headerlink" href="#autopilot-communication" title="Permanent link">&para;</a></h3>
<p>Once in guided or offboard mode, the autopilot by default expects communications using the <a href="https://mavlink.io/en/messages/common.html">MAVLINK protocol</a>. Traditionally this would have been used for a ground control station (GCS) to send commands to a UAV over a telemetry link. However, now it has also developed into a protocol for commanding the autopilot from an onboard companion computer over a USB or serial connection too. The MAVLink protocol is a set of preset commands which compatible firmwares understand and react to. In this tutorial we will primarily be observing the MAVlink interface, but we will not get into writing your own software with MAVlink yet.</p>
<p>With the growing prevalence of ROS2, all of the major firmwares have attempted to provide direct communication using ROS2's underlying communication/middleware protocol of DDS (Data Distribution Service). Although we will not cover this in this module, this is what we currently use to communicate between a companion computer and the Pixhawk for drone work. </p>
<p>Note however that even if DDS is enabled, autopilots will still send Mavlink messages down a <em>Telemetry</em> stream - often a dedicated low bandwidth communication channel for the monitoring of the drone's health and status. </p>
<h3 id="ground-stations">Ground Stations<a class="headerlink" href="#ground-stations" title="Permanent link">&para;</a></h3>
<p>A key element of any drone operation is a competent and reliable ground station setup. The purpose of the ground station is to provide a reliable communication link with the drone and receive telemetry to be able to keep an eye on, and monitor the status of the drone. Often this is done via a second <em>telemtry</em> radio operating on a different frequency - in our case an SIK radio on 433MHz - with one end connected to the drone, and the other connected via USB to a laptop or computer (or handheld games console like the steam deck). </p>
<p>There are a number of choices for a piece of software which runs on the ground station. In industry, you may see Alterion or other softwares which provide an interface. In the open source world we either use <em>mission planner</em> with Ardupilot or <em>QGroundControl</em> with PX4. In this tutorial we will trying to use <strong>QGroundControl</strong> (QGC). </p>
<p><img alt="QGC" src="../images/QGC.png" /></p>
<p>Tools like QGC are crucial for real-time <strong>flight monitoring, control, and mission planning</strong>. It allows users to:</p>
<ul>
<li><strong>Monitor telemetry data</strong> (battery levels, GPS status, IMU readings, etc.).</li>
<li><strong>Send flight commands</strong> such as takeoff, landing, and mission execution.</li>
<li><strong>Configure drone parameters</strong> including PID tuning, sensor calibrations, and failsafe settings.</li>
<li><strong>Visualize the drone's location</strong> and trajectory on a map interface.</li>
<li><strong>Log and analyze flight data</strong> to debug issues or optimize performance.</li>
</ul>
<p>Ground stations are useful as they enable:</p>
<ul>
<li><strong>Safety</strong>: Enables real-time monitoring, preventing potential failures.</li>
<li><strong>Ease of Use</strong>: Provides a user-friendly interface to interact with the drone.</li>
<li><strong>Flexibility</strong>: Supports different flight modes (manual, autonomous, guided, etc.).</li>
<li><strong>Data Logging</strong>: Essential for post-flight analysis, AI training, and debugging.</li>
<li><strong>Remote Control</strong>: Operate the drone without requiring direct physical interaction.</li>
</ul>
<h2 id="setting-up-pixhawk-with-px4-and-qgroundcontrol">Setting Up Pixhawk with PX4 and QGroundControl<a class="headerlink" href="#setting-up-pixhawk-with-px4-and-qgroundcontrol" title="Permanent link">&para;</a></h2>
<p>Now let's set up your Pixhawk with PX4, connect to it and do some initial calibrations with QGC. </p>
<h3 id="setup-overview">Setup Overview<a class="headerlink" href="#setup-overview" title="Permanent link">&para;</a></h3>
<ol>
<li>Install <strong>QGroundControl (QGC)</strong> (<a href="https://qgroundcontrol.com/">Download</a>)</li>
<li>Flash <strong>PX4 firmware</strong> onto Pixhawk via QGC</li>
<li>Configure <strong>sensors and RC calibration</strong></li>
<li>Use <em>QGC</em> to set up some automated flights</li>
<li>(Not today) Setup <strong>offboard control</strong> (for AI/robotics integration)</li>
</ol>
<h3 id="install-qgroundcontrol">Install QGroundControl<a class="headerlink" href="#install-qgroundcontrol" title="Permanent link">&para;</a></h3>
<p>Follow the following instructions for all platforms:</p>
<ul>
<li><a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/getting_started/quick_start.html">https://docs.qgroundcontrol.com/master/en/qgc-user-guide/getting_started/quick_start.html</a></li>
</ul>
<h3 id="power-up-and-connect-the-pixhawk">Power up and connect the Pixhawk<a class="headerlink" href="#power-up-and-connect-the-pixhawk" title="Permanent link">&para;</a></h3>
<p>Tidily unbox the Pixhawk box in a way that you can put everything back later! For this tutorial, all you will need is:</p>
<ul>
<li>Pixhawk</li>
<li>USB-C cable</li>
</ul>
<p>Plug the USB-C cable from the Pixhawk to a port in your laptop</p>
<p>Now start QGroundControl</p>
<p>In the top left it will hopefully automatically pick up the Pixhawk and you can start browsing the settings and seeing the live view. </p>
<p>See <a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/getting_started/quick_start.html">https://docs.qgroundcontrol.com/master/en/qgc-user-guide/getting_started/quick_start.html</a> for how to navigate and use QGC.</p>
<h3 id="flashing-the-pixhawk">Flashing the Pixhawk<a class="headerlink" href="#flashing-the-pixhawk" title="Permanent link">&para;</a></h3>
<p>The first step for us is to flash the latest PX4 version onto the pixhawk. This can be done easily from within QGC. </p>
<p>Follow the following instruction page:</p>
<ul>
<li><a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/setup_view/firmware.html">https://docs.qgroundcontrol.com/master/en/qgc-user-guide/setup_view/firmware.html</a></li>
</ul>
<h3 id="sensor-calibration">Sensor Calibration<a class="headerlink" href="#sensor-calibration" title="Permanent link">&para;</a></h3>
<p>The next step would be to perform sensor calibration in order to calibrate the onboard accelerometer and gyroscope. In the setup menu go to the sensors tab and follow the instructions. </p>
<blockquote>
<p>Of course in practice you would perform the calibration after having built the drone, but this will do for now!</p>
</blockquote>
<h3 id="continue-setup">Continue Setup<a class="headerlink" href="#continue-setup" title="Permanent link">&para;</a></h3>
<p>Scroll through the other setup steps, there are a number that we are skipping in this session, but in practice you would have to usually complete:</p>
<ul>
<li><strong>Radio Setup</strong>: It's standard to have a radio connected with both a receiver connected to the pixhawk and a transmitter with the dedicated pilot. The radio is important in order to have a backup method of controlling the drone, as well enabling mode switching between various manual flight regimes and offboard mode. Important for safety too as having a emergency stop setup is highly recommended </li>
<li><strong>Safety Setup</strong>: All the different safety systems built in from <em>return to home</em> to parachutes if they're installed. </li>
<li><strong>Parameters</strong>: All of these setup screens essentially manipulate the value of various parameters under the hood. Have a scroll through the parameter list and you will quickly see that there are a lot of options for a variety of scenarios. Bear in mind that PX4 is highly multi-functional as it has been written to work on anything from fixed-wing aircraft to mini-submarines! </li>
</ul>
<blockquote>
<p>You might want to try setting up the virtual joystick to enable easier testing! <a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/setup_view/joystick.html">Joystick</a></p>
</blockquote>
<h3 id="next-step">Next step<a class="headerlink" href="#next-step" title="Permanent link">&para;</a></h3>
<p>So once the setup is complete, the last thing to have a look at is observing some of the MAVLink that's coming through </p>
<p>Go have a look at the Analyse View: <a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/">analyse view</a>, and then the <a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/mavlink_inspector.html">mavlink inspector</a></p>
<p>However you will note that because we have a "drone" (just the Pixhawk sitting on your desk that wont fly) you wont really be able to do much with it. Traditionally we would use Software In The Loop testing to simulate a virtual Pixhawk for testing and development. However in this class we would like to try and use Hardware-In-The-Loop testing to "fly" your drone. </p>
<h2 id="using-px4-in-hitl-hardware-in-the-loop-simulation">Using PX4 in HITL (Hardware-In-The-Loop) Simulation<a class="headerlink" href="#using-px4-in-hitl-hardware-in-the-loop-simulation" title="Permanent link">&para;</a></h2>
<p>For development and testing in industry, we often use Software-In-The-Loop (SITL) which allows us to test the functionality of one or more drones from our laptops without needing physical access to the real drones. To be specific the SITL literally runs the exact same firmware that would be running on the Pixhawk, and not some simulated version. Often a SITL is paired with a simulator of some description (by default gazebo) to provide physics input to simulate sensors and other external devices. </p>
<p>However for the purpose of this workshop, we have decided to introduce <strong>Hardware-In-The-Loop</strong> (HITL) testing. This is often a later step of development testing when you have written new firmware, or simply want to make sure the physical PCBs and microcontrollers are functioning as expected. In HITL testing, a real Pixhawk is plugged into a computer, where the computer again uses a simulator to simulate physics and sensors which is passed back into the Pixhawk. Cruically this hopefully avoids computer setup issues for software while allowing real-time testing on actual hardware.</p>
<p>To make this a bit different, and to hopefully avoid compatibility issues with other work, we have decided to recommend the use of <strong>JMavSim</strong> simulator instead of Gazebo for this session. <strong>JMavSim</strong> is another simulator specifically designed for fixed wing and multi-rotor platforms, but does not include the general physics capabilities that Gazebo includes. Because of this it is much lighter weight, and there have been works which run JMavSim onboard in the loop for model-predictive-control predictions. </p>
<ul>
<li>Read about it here (along with keyboard controls): <a href="https://github.com/PX4/jMAVSim">https://github.com/PX4/jMAVSim</a></li>
</ul>
<h3 id="installing-dependencies">Installing Dependencies<a class="headerlink" href="#installing-dependencies" title="Permanent link">&para;</a></h3>
<p>Ensure you have QGC installed with joystick enabled</p>
<p>For non-Ubuntu, please see the following instructions:</p>
<ul>
<li><a href="https://docs.px4.io/main/en/dev_setup/dev_env.html">https://docs.px4.io/main/en/dev_setup/dev_env.html</a></li>
</ul>
<p><strong>Although Be Aware That It May Mess With Your Current Installation of Gazebo</strong> </p>
<p>Options are:
- Docker (and forwarding the volume representing the Pixhawk)
- Following the cherry-picked Ubuntu instructions below</p>
<p>Would not recommend a virtual machine since we are connecting real hardware up. (Unless you just want to try out the SITL)</p>
<h4 id="ubuntu">Ubuntu<a class="headerlink" href="#ubuntu" title="Permanent link">&para;</a></h4>
<p>Git clone and install PX4</p>
<pre><code>git clone --recursive https://github.com/PX4/PX4-Autopilot.git -b v1.15.4
cd PX4-Autopilot
</code></pre>
<blockquote>
<p><em>NOTE</em>: You will need the <code>--recursive</code> to ensure all the dependencies are also pulled. If you forgot to and your builds are failing, in the root of the repository run <code>git submodule update --init --recursive</code>. </p>
</blockquote>
<h4 id="jmavsim-install-ubuntu-tested">JMavSim Install (Ubuntu Tested)<a class="headerlink" href="#jmavsim-install-ubuntu-tested" title="Permanent link">&para;</a></h4>
<pre><code class="language-bash"># check ubuntu version
# otherwise warn and point to docker?
UBUNTU_RELEASE=&quot;`lsb_release -rs`&quot;

if [[ &quot;${UBUNTU_RELEASE}&quot; == &quot;14.04&quot; ]]; then
    echo &quot;Ubuntu 14.04 is no longer supported&quot;
    exit 1
elif [[ &quot;${UBUNTU_RELEASE}&quot; == &quot;16.04&quot; ]]; then
    echo &quot;Ubuntu 16.04 is no longer supported&quot;
    exit 1
elif [[ &quot;${UBUNTU_RELEASE}&quot; == &quot;18.04&quot; ]]; then
    echo &quot;Ubuntu 18.04&quot;
elif [[ &quot;${UBUNTU_RELEASE}&quot; == &quot;20.04&quot; ]]; then
    echo &quot;Ubuntu 20.04&quot;
elif [[ &quot;${UBUNTU_RELEASE}&quot; == &quot;22.04&quot; ]]; then
    echo &quot;Ubuntu 22.04&quot;
fi

# General simulation dependencies
sudo DEBIAN_FRONTEND=noninteractive apt-get -y --quiet --no-install-recommends install \
    bc \
    ;

if [[ &quot;${UBUNTU_RELEASE}&quot; == &quot;18.04&quot; ]]; then
    java_version=11
elif [[ &quot;${UBUNTU_RELEASE}&quot; == &quot;20.04&quot; ]]; then
    java_version=13
elif [[ &quot;${UBUNTU_RELEASE}&quot; == &quot;22.04&quot; ]]; then
    java_version=11
else
    java_version=14
fi
# Java (jmavsim)
sudo DEBIAN_FRONTEND=noninteractive apt-get -y --quiet --no-install-recommends install \
    ant \
    openjdk-$java_version-jre \
    openjdk-$java_version-jdk \
    libvecmath-java \
    ;

# Set Java 11 as default
sudo update-alternatives --set java $(update-alternatives --list java | grep &quot;java-$java_version&quot;)
</code></pre>
<h3 id="steps-to-run-px4-hitl">Steps to Run PX4 HITL:<a class="headerlink" href="#steps-to-run-px4-hitl" title="Permanent link">&para;</a></h3>
<p>These instructions here are based on the following document: <a href="https://docs.px4.io/main/en/simulation/hitl.html">https://docs.px4.io/main/en/simulation/hitl.html</a></p>
<p>They have been updated and adjusted </p>
<h4 id="starting-pixhawk">Starting Pixhawk<a class="headerlink" href="#starting-pixhawk" title="Permanent link">&para;</a></h4>
<p>Using the USB cable, plug the pixhawk into your computer. </p>
<p>Now start QGroundControl - if you are lucky after a few seconds, QGC should automatically detect your drone. </p>
<blockquote>
<p>If not, it could be anything from the cable you are using to your OS not assigning the serial port correctly. </p>
</blockquote>
<h4 id="configuring-your-pixhawkpx4-installation-for-hitl">Configuring your Pixhawk/PX4 installation for HITL<a class="headerlink" href="#configuring-your-pixhawkpx4-installation-for-hitl" title="Permanent link">&para;</a></h4>
<p>Within QGC we need to setup PX4 into HITL mode - this follows the above linked guide</p>
<ol>
<li>Open Setup (click the Q in the top left) -&gt; Vehicle Setup -&gt; Safety</li>
<li>Enable HITL mode by selecting Enabled from the <em>HITL Enabled</em> List</li>
</ol>
<p><img alt="setup HITL" src="../images/QGC_Setup_HITL.png" /></p>
<ol>
<li>Restart the Pixhawk (Unplug and plug it back in again)</li>
<li>Go to Vehicle Setup again and go to Airframe</li>
<li>Click on the <em>Simulation</em> airframe and ensure that "HIL Quadcopter X" is selected</li>
</ol>
<p><img alt="setup Airframe" src="../images/QGC_Setup_Airframe.png" /></p>
<ol>
<li>Note that we do not have an external radio so we will not be able to perform these steps (instead we use the QGC joysticks). There may be an error that comes up because of this - you are mostly okay to ignore these warning/error messages. </li>
<li>In order to use QGC Joystick, you will need to change some parameters. Go to Vehicle Setup -&gt; Parameters. Search and change the following.</li>
<li>COM_RC_IN_MODE to "RC and Joystick with fallback". This allows joystick input and disables RC input checks.</li>
<li>NAV_RCL_ACT to "Disarm". This ensures that no RC failsafe actions interfere when not running HITL with a radio control.</li>
</ol>
<p><img alt="setup Parameters" src="../images/QGC_Setup_Parameters.png" /></p>
<h4 id="running-jmavsim">Running JMAVSim<a class="headerlink" href="#running-jmavsim" title="Permanent link">&para;</a></h4>
<p>Ensure QGC is closed first</p>
<p>Open a terminal and navigate to the PX4_Autopilot repo you cloned earlier</p>
<pre><code class="language-bash"># Set Lat Long of UCL East
export PX4_HOME_LAT=51.537668693830824
export PX4_HOME_LON=-0.012029639288719024
export PX4_HOME_ALT=28.5
# Run JMavSim
./Tools/simulation/jmavsim/jmavsim_run.sh -q -s -d /dev/ttyACM0 -b 921600 -r 250
</code></pre>
<blockquote>
<p>If you get an error make sure you have recursively git cloned</p>
<p><strong>INFO</strong> Replace the serial port name /dev/ttyACM0 as appropriate. On macOS this port would be /dev/tty.usbmodem1. On Windows (including Cygwin) it would be the COM1 or another port - check the connection in the Windows Device Manager.</p>
</blockquote>
<p>Once started, now separately (in a new terminal or otherwise) restart QGC. </p>
<p><img alt="jmavsim_QGC" src="../images/QGC_HITL_Jmavsim.png" /></p>
<p>Tada! After waiting about a minute for the system to initialise itself (It will complain at you a bunch), QGC should show that the system is ready to fly. </p>
<h2 id="tasks">Tasks<a class="headerlink" href="#tasks" title="Permanent link">&para;</a></h2>
<ol>
<li>Takeoff the drone and manually fly it around the olympic park using the joysticks in the bottom of the screen<ul>
<li>See your trajectory in QGC</li>
<li>Try some of the keyboard shortcuts of JMavSim to see your drone fly differently </li>
</ul>
</li>
</ol>
<blockquote>
<p>Note: If you crash your drone somehow, you may need to restart your flight controller and jmavsim</p>
</blockquote>
<ol>
<li>
<p>When in midair, right click on a location and you will get some options to fly in a straight line to various locations. </p>
</li>
<li>
<p>Land or return to the start location</p>
</li>
<li>
<p>Have a play with the planning tools</p>
<ul>
<li>Once you have made a mission you will need to upload it (this may appear to fail)</li>
<li>If you can't automatically start it, you may need to manually change the mode to <em>mission</em>. </li>
</ul>
</li>
<li>
<p>Imagine you were a drone inspection company, do you think this software is suitable for your role? </p>
<ul>
<li>What's this software good at?</li>
<li>What's it missing? </li>
</ul>
</li>
</ol>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>In this tutorial, we introduced the following</p>
<ul>
<li><strong>Pixhawk</strong>: The hardware autopilot platform</li>
<li><strong>PX4</strong>: The open-source flight control firmware</li>
<li><strong>How to set up and use PX4 with Pixhawk</strong></li>
<li><strong>PX4 Hardware In The Loop (HITL) Testing</strong></li>
<li><strong>Creating Missions with QGC</strong></li>
</ul>
<p>For more details, refer to the <a href="https://docs.px4.io/">PX4 Developer Guide</a>.</p>
<p>This is all we'll cover in this course, as this content could fill a whole other module. In the optional session we will be trying to put some of this into practice on a real drone in the flight arena. Specifically connecting some of this up to ROS2 and Aerostack2 and seeing how this performs! </p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright Â© 2024 University College London AML Lab</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
